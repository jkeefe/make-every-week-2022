<h1 id="covid-cases-animation">Covid cases animation</h1>
<p>[image]</p>
<p>I've been both awed and terrified by the transmissibility of Omicron and the speed at which it's spread. As the case curves hockey-sticked upward and the maps all turned red, I thought it'd be interesting to visualize the spread of this new twist on the virus.</p>
<p>So the other day, while doing some work mapping Covid-19 data by US counties, I realized it wouldn't take much to generate a map for each day of the pandemic ... and make those maps into a movie.</p>
<p>It almost seems like cheating to use a work project as one of my "Make Every Week" projects, but I'm lucky to have a job where creative tinkering is celebrated. When I shared a tinker-made movie of six months of case data with colleagues Kaeti Hinck and Sean O'Key, they thought it would make <a href="https://www.cnn.com/2022/01/14/us/covid-cases-animation/index.html">a good data feature for CNN</a>.</p>
<p>While truly a horrible topic — nearly every county is now reporting more than 100 cases per 100,000 people — the process of turning that case data into a movie was a worthy project. And I did it almost entirely from the command line (the text-only interface that is my Mac's "Terminal" program).</p>
<h2 id="case-data">Case data</h2>
<p>The case data for every day in the pandemic, by county, is freely available <a href="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv">in the Github repository</a> maintained by the Johns Hopkins University Center for Systems Science and Engineering. I downloaded it from the command line using the <a href="https://curl.se/docs/manual.html"><code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">curl</code></a> command.</p>
<p>The John's Hopkins data tracks daily <em>cumulative</em> cases by county, so I had to do a little math to get the <em>new</em> cases (the difference from the day before) and the 7-day rolling average for each day.</p>
<p>To get the rate per 100,000 people in each county, I needed the county populations, which are available from the US Census Bureau. I was fortunate to have those tables handy, since a bunch of us worked on them when the 2020 data came out. But you can also get them from the <a href="https://data.census.gov/cedsci/table?t=Populations%20and%20People&amp;g=0100000US%240500000&amp;y=2020&amp;tid=DECENNIALPL2020.P1">Census website</a> (which I've <a href="linktk">downloaded</a>, too.) The "P1_001N" column is the total population.</p>
<p>Tip: The "FIPS" code, which is the key to joining the Census data to the Johns Hopkins data, is the last five characters of the "GEO_ID" in the population table.</p>
<h2 id="command-line-cartography">Command-line cartography</h2>
<p>Also available from the <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">Census website</a> are the national county <a href="https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_20m.zip">shapefiles</a>.</p>
<p>With the data and the shapes by county, I can use the amazing <a href="https://mapshaper.org">Mapshaper</a> tool's <a href="https://github.com/mbloch/mapshaper/wiki/Command-Reference">commands</a> to build the maps. The <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">-i</code> command takes in the shapefile, the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">-join</code> command marries the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">.csv</code> with the shapefile, and the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">-classify</code> command colors each county based on the case rate, allowing for custom colors and breaks, such as the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">50,70,100,250</code> I used.</p>
<p>Fortunately the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">-o</code> or <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">-output</code> command will save the map as an SVG if you use the <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">.svg</code> extension on the file name. This key, since SVGs can become images that can become frames of a movie.</p>
<p>I had to run a Mapshaper command for each day — to make a map a day — and I'm not good enough on the command line to make it run loops. But Mapshaper works <a href="https://github.com/mbloch/mapshaper/wiki/Using-mapshaper-programmatically#option-two-node-api">programmatically in Nodejs</a>, so I wrote a little script to do that.</p>
<h2 id="command-line-movie-making">Command-line movie-making</h2>
<p>With a folder full of SVGs, I used <a href="https://imagemagick.org/script/mogrify.php">Imagemagick Mogrify</a> to batch-format them into PNGs and also adjust each image's "extent," or canvas, to the video-frame size I needed.</p>
<p>I used a couple of other Imagemagick tricks to <a href="https://stackoverflow.com/questions/23236898/add-text-on-image-at-specific-point-using-imagemagick/23238369">draw</a> the dates on each image. And then I made a legend in Adobe Illustrator and saved it as a PNG, which I then overlaid on every map image using <a href="https://imagemagick.org/script/composite.php">Imagemagick composite</a>.</p>
<p>Finally, I used the command-line program <a href="https://www.ffmpeg.org/download.html"><code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">ffmpeg</code></a> to turn my folder of <a href="https://hamelot.io/visualization/using-ffmpeg-to-convert-a-set-of-images-into-a-video/">images into a video</a>.</p>
<h2 id="makefile-making">Makefile making</h2>
<p>Instead of trying to remember each command-line command as I go along, I've made a habit of writing each command into a <a href="https://makefiletutorial.com/">Makefile</a>. Then I can <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">make maps</code> or <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">make legends</code>, which then runs the commands to complete the task. It also give me a de-facto, executable log of what worked — which was essential, since I ended up making several iterations before the final version. </p>
<p>In the end, my <code style="font-family: Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;">make movie</code> command takes about five minutes to run ... and when it's done, I have the animation you can see <a href="https://www.cnn.com/2022/01/14/us/covid-cases-animation/index.html">atop the story</a>.</p>
<p>Six months from now, I hope to use the same code to show how Covid-19 disappeared into the background of our lives. </p>